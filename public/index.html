<!DOCTYPE html>
<html>
  <head>
    <title>socket.io chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
  </head>
  <body>
    <script>
      $(function() {
// chat部分
        let name = prompt('名前を入力してください');
        let socketio = io();

        $('#message_form').submit(function(){
          let data = JSON.stringify({ name:name, message:$('#input_msg').val(), action:'chat' });
          socketio.emit('message', data);
          $('#input_msg').val('');
          return false;
        });

// オブジェクト生成
        if (name) {
          let user_ball = document.createElement('div');
          user_ball.style.position = "absolute";

          let randLeft = 10 + Math.random()*260;
          let randTop = 10 + Math.random()*260;

          user_ball.style.left = randLeft;
          user_ball.style.top = randTop;

          user_ball.style.width = "80px";
          user_ball.style.height = "80px";
          user_ball.style.borderRadius = "50%";
          user_ball.style.background = "white";
          user_ball.style.border = "solid 3px skyblue";
          user_ball.innerHTML = name;
          user_ball.style.textAlign = "center";
          user_ball.style.lineHeight = ("80px");

          $('#box').append(user_ball);
        }
// 動かすところ
        let flag = false;

        $('#target').draggable();
        $('#target').mousedown(function () {
          flag = true;
        });
        $('#target').mouseup(function() {
          flag=false;
        });
        $('#box').mousemove(function(event) {
          let x = event.pageX - $('#box').position().left;
          let y = event.pageY - $('#box').position().top;

          if(flag) {
            $('#target').css('left',x);
            $('#target').css('top', y);

            let data = JSON.stringify({ x:x, y:y, action:'mousemove'})
            socketio.emit('message', data);
          }
        });

// 受信
        socketio.on('message', function(msg){
            let data = JSON.parse(msg);
            switch(data.action) {
            case 'mousemove':
              $('#box-x').text('X: ' + data.x);
              $('#box-y').text('Y: ' + data.y);
              $('#target').css('left', obj.x);
              $('#target').css('top', obj.y);
              break;
            case 'chat':
              $('#messages').append($('<p>').text( data.name + ' : ' +data.message));
              break;
            }
        });
      });
    </script>
    <h1>Socket IO を使ってみよう</h1>
    <!--move object-->
    <div id="box" style="width:540px; height:250px; background-color:blue">
<!--
      <div id="target" style="width:40px; height:20px; background-color:green;"></div>
-->
    </div>
    <span id="box-x" style="display:block;"></span>
    <span id="box-y" style="display:block;"></span>
    <!--chat-->
    <form id="message_form" action="#">
      <input id="input_msg" autocomplete="off" />
      <button>Send</button>
    </form>
    <ul id="messages"></ul>

  </body>
</html>
